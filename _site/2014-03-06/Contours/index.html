<!DOCTYPE html>
<head>
  <meta http-equiv="Content-type" content="text/html; charset=utf-8">
  <title>Contoursの構造を調べる</title>
  <link rel="stylesheet" href="/assets/css/style.css" type="text/css">
  <link rel="stylesheet" href="/assets/css/syntax.css" type="text/css">
  <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
</head>
<body>
  <header>
  <div>06 Mar 2014</div>
  <h1>Contoursの構造を調べる</h1>
</header>

<div class='main'>
  <h2 id="contours">Contoursとは</h2>

<p><a href="http://docs.opencv.org/trunk/modules/imgproc/doc/structural_analysis_and_shape_descriptors.html?highlight=contour#cv2.findContours">opencvのfindContours</a>により得られるデータ。この関数は与えられた画像のなかである形を検出すると、その輪郭となる曲線を一連の点で表現して返す。 例は <a href="https://www.google.co.jp/search?q=opencv+contour+sample+image&client=firefox-aurora&hs=3OS&rls=org.mozilla:ja-JP-mac:unofficial&hl=ja&channel=fflb&tbm=isch&tbo=u&source=univ&sa=X&ei=ogUYU4_iM4yNkwWl5IHwDw&ved=0CCcQsAQ&biw=1280&bih=925">netで検索すれば</a>大量にみつかる。</p>

<p>この関数を近デジの書籍のページ画像に適用して、文字の切り出しに活用してみよう、というのがこのページの趣旨である。</p>

<h2 id="pythoncontour">pythonとcontour</h2>

<p>contourは一連の点であるが、pythonでは数値の配列の配列の配列がひとつのcontourとなり、その配列がfindContoursの戻り値である。 ややこしいのでもうすこし説明を加える。</p>

<ul>
<li>数値の配列
<ul>
<li>とは、いまは対象が2次元画像なので座標は2つ、つまり [x, y] という配列がひとつの点を表す。</li>
</ul>
</li>

<li>その配列
<ul>
<li>といっても、[[x,y]] と要素がひとつだけで、点を括弧でくくっただけ(意味がいまいちよくわからない)</li>
</ul>
</li>

<li>その配列
<ul>
<li>たとえば [[[438, 524]], [[439, 525]],[[439, 528]] ] は点の集合をあらわす。これがひとつのcontourである。</li>
</ul>
</li>

<li>その配列
<ul>
<li>findContoursは画像から検出したすべてのcontourをひとつの配列として戻り値を構成するのである。</li>
</ul>
</li>
</ul>

<h2 id="sample_image">Sample Image</h2>

<p>これは近デジから取得した画像の断片である。 <img src="/images/twletters.jpg" alt="twletters.jpg" /> この例を使い、実際にcontourを求めその活用法を述べる。</p>

<h2 id="code">Code</h2>

<p>contourを得るコードの主要な部分は</p>
<div class='highlight'><pre><code class='python'><span class='lineno'>1</span>  <span class='c'>#Load image</span>
<span class='lineno'>2</span>  <span class='n'>img</span> <span class='o'>=</span> <span class='n'>cv2</span><span class='o'>.</span><span class='n'>imread</span><span class='p'>(</span><span class='n'>infilename</span><span class='p'>)</span>
<span class='lineno'>3</span>  <span class='c'># get contours</span>
<span class='lineno'>4</span>  <span class='n'>gray</span> <span class='o'>=</span> <span class='n'>cv2</span><span class='o'>.</span><span class='n'>cvtColor</span><span class='p'>(</span><span class='n'>img</span><span class='p'>,</span><span class='n'>cv2</span><span class='o'>.</span><span class='n'>COLOR_BGR2GRAY</span><span class='p'>)</span>
<span class='lineno'>5</span>  <span class='n'>ret</span><span class='p'>,</span><span class='n'>thresh</span> <span class='o'>=</span> <span class='n'>cv2</span><span class='o'>.</span><span class='n'>threshold</span><span class='p'>(</span><span class='n'>gray</span><span class='p'>,</span> <span class='n'>thresh_low</span><span class='p'>,</span> <span class='n'>thresh_high</span><span class='p'>,</span> <span class='mi'>0</span><span class='p'>)</span>                                                                          <span class='err'>│</span>
<span class='lineno'>6</span>  <span class='n'>contours</span><span class='p'>,</span> <span class='n'>hierarchy</span> <span class='o'>=</span> <span class='n'>cv2</span><span class='o'>.</span><span class='n'>findContours</span><span class='p'>(</span><span class='n'>thresh</span><span class='p'>,</span><span class='n'>cv2</span><span class='o'>.</span><span class='n'>RETR_LIST</span><span class='p'>,</span><span class='n'>cv2</span><span class='o'>.</span><span class='n'>CHAIN_APPROX_SIMPLE</span><span class='p'>)</span>
</code></pre></div>
<p>のようになる。</p>

<p>imread で読みこんだ画像データを、findContours関数にわたせばその戻り値として配列が得られる。</p>

<p>この画像は縦横が 558 pixel x 669 pixel、の小さなものだが、</p>

<p>次に示すようにこの画像から検出したcontours配列の長さ(contourの数)は217、それぞれのcontourが含む点の数も次のようなものとなる。</p>
<div class='highlight'><pre><code class='python'><span class='p'>(</span><span class='n'>Pdb</span><span class='p'>)</span> <span class='nb'>len</span><span class='p'>(</span><span class='n'>contours</span><span class='p'>)</span>
<span class='mi'>217</span>
<span class='p'>(</span><span class='n'>Pdb</span><span class='p'>)</span> <span class='p'>[</span><span class='nb'>len</span><span class='p'>(</span><span class='n'>x</span><span class='p'>)</span> <span class='k'>for</span> <span class='n'>x</span> <span class='ow'>in</span> <span class='n'>contours</span><span class='p'>]</span>
<span class='p'>[</span><span class='mi'>14</span><span class='p'>,</span> <span class='mi'>20</span><span class='p'>,</span> <span class='mi'>19</span><span class='p'>,</span> <span class='mi'>22</span><span class='p'>,</span> <span class='mi'>40</span><span class='p'>,</span> <span class='mi'>12</span><span class='p'>,</span> <span class='mi'>6</span><span class='p'>,</span> <span class='mi'>14</span><span class='p'>,</span> <span class='mi'>26</span><span class='p'>,</span> <span class='mi'>4</span><span class='p'>,</span> <span class='mi'>22</span><span class='p'>,</span> <span class='mi'>11</span><span class='p'>,</span> <span class='mi'>8</span><span class='p'>,</span> <span class='mi'>7</span><span class='p'>,</span> <span class='mi'>7</span><span class='p'>,</span> <span class='mi'>36</span><span class='p'>,</span> <span class='mi'>51</span><span class='p'>,</span> <span class='mi'>6</span><span class='p'>,</span> <span class='mi'>18</span><span class='p'>,</span>
 <span class='mi'>11</span><span class='p'>,</span> <span class='mi'>13</span><span class='p'>,</span> <span class='mi'>6</span><span class='p'>,</span> <span class='mi'>6</span><span class='p'>,</span> <span class='mi'>9</span><span class='p'>,</span> <span class='mi'>4</span><span class='p'>,</span> <span class='mi'>31</span><span class='p'>,</span> <span class='mi'>12</span><span class='p'>,</span> <span class='mi'>46</span><span class='p'>,</span> <span class='mi'>6</span><span class='p'>,</span> <span class='mi'>6</span><span class='p'>,</span> <span class='mi'>6</span><span class='p'>,</span> <span class='mi'>10</span><span class='p'>,</span> <span class='mi'>7</span><span class='p'>,</span> <span class='mi'>13</span><span class='p'>,</span> <span class='mi'>10</span><span class='p'>,</span> <span class='mi'>1</span><span class='p'>,</span> <span class='mi'>6</span><span class='p'>,</span> <span class='mi'>34</span><span class='p'>,</span> <span class='mi'>6</span><span class='p'>,</span>
 <span class='mi'>9</span><span class='p'>,</span> <span class='mi'>6</span><span class='p'>,</span> <span class='mi'>8</span><span class='p'>,</span> <span class='mi'>29</span><span class='p'>,</span> <span class='mi'>5</span><span class='p'>,</span> <span class='mi'>24</span><span class='p'>,</span> <span class='mi'>13</span><span class='p'>,</span> <span class='mi'>6</span><span class='p'>,</span> <span class='mi'>23</span><span class='p'>,</span> <span class='mi'>13</span><span class='p'>,</span> <span class='mi'>6</span><span class='p'>,</span> <span class='mi'>4</span><span class='p'>,</span> <span class='mi'>6</span><span class='p'>,</span> <span class='mi'>44</span><span class='p'>,</span> <span class='mi'>6</span><span class='p'>,</span> <span class='mi'>16</span><span class='p'>,</span> <span class='mi'>25</span><span class='p'>,</span> <span class='mi'>4</span><span class='p'>,</span> <span class='mi'>10</span><span class='p'>,</span> <span class='mi'>6</span><span class='p'>,</span>
 <span class='mi'>8</span><span class='p'>,</span> <span class='mi'>6</span><span class='p'>,</span> <span class='mi'>4</span><span class='p'>,</span> <span class='mi'>7</span><span class='p'>,</span> <span class='mi'>4</span><span class='p'>,</span> <span class='mi'>8</span><span class='p'>,</span> <span class='mi'>4</span><span class='p'>,</span> <span class='mi'>72</span><span class='p'>,</span> <span class='mi'>7</span><span class='p'>,</span> <span class='mi'>9</span><span class='p'>,</span> <span class='mi'>6</span><span class='p'>,</span> <span class='mi'>8</span><span class='p'>,</span> <span class='mi'>49</span><span class='p'>,</span> <span class='mi'>12</span><span class='p'>,</span> <span class='mi'>1</span><span class='p'>,</span> <span class='mi'>6</span><span class='p'>,</span> <span class='mi'>8</span><span class='p'>,</span> <span class='mi'>93</span><span class='p'>,</span> <span class='mi'>57</span><span class='p'>,</span> <span class='mi'>36</span><span class='p'>,</span> <span class='mi'>4</span><span class='p'>,</span>
 <span class='mi'>14</span><span class='p'>,</span> <span class='mi'>41</span><span class='p'>,</span> <span class='mi'>12</span><span class='p'>,</span> <span class='mi'>6</span><span class='p'>,</span> <span class='mi'>11</span><span class='p'>,</span> <span class='mi'>23</span><span class='p'>,</span> <span class='mi'>18</span><span class='p'>,</span> <span class='mi'>21</span><span class='p'>,</span> <span class='mi'>14</span><span class='p'>,</span> <span class='mi'>6</span><span class='p'>,</span> <span class='mi'>5</span><span class='p'>,</span> <span class='mi'>10</span><span class='p'>,</span> <span class='mi'>9</span><span class='p'>,</span> <span class='mi'>26</span><span class='p'>,</span> <span class='mi'>14</span><span class='p'>,</span> <span class='mi'>25</span><span class='p'>,</span> <span class='mi'>13</span><span class='p'>,</span> <span class='mi'>25</span><span class='p'>,</span>
 <span class='mi'>14</span><span class='p'>,</span> <span class='mi'>38</span><span class='p'>,</span> <span class='mi'>21</span><span class='p'>,</span> <span class='mi'>8</span><span class='p'>,</span> <span class='mi'>6</span><span class='p'>,</span> <span class='mi'>41</span><span class='p'>,</span> <span class='mi'>45</span><span class='p'>,</span> <span class='mi'>8</span><span class='p'>,</span> <span class='mi'>31</span><span class='p'>,</span> <span class='mi'>20</span><span class='p'>,</span> <span class='mi'>19</span><span class='p'>,</span> <span class='mi'>4</span><span class='p'>,</span> <span class='mi'>15</span><span class='p'>,</span> <span class='mi'>6</span><span class='p'>,</span> <span class='mi'>9</span><span class='p'>,</span> <span class='mi'>24</span><span class='p'>,</span> <span class='mi'>8</span><span class='p'>,</span> <span class='mi'>12</span><span class='p'>,</span> <span class='mi'>10</span><span class='p'>,</span> 
 <span class='mi'>2</span><span class='p'>,</span> <span class='mi'>20</span><span class='p'>,</span> <span class='mi'>18</span><span class='p'>,</span> <span class='mi'>6</span><span class='p'>,</span> <span class='mi'>14</span><span class='p'>,</span> <span class='mi'>4</span><span class='p'>,</span> <span class='mi'>11</span><span class='p'>,</span> <span class='mi'>16</span><span class='p'>,</span> <span class='mi'>28</span><span class='p'>,</span> <span class='mi'>80</span><span class='p'>,</span> <span class='mi'>41</span><span class='p'>,</span> <span class='mi'>8</span><span class='p'>,</span> <span class='mi'>39</span><span class='p'>,</span> <span class='mi'>12</span><span class='p'>,</span> <span class='mi'>6</span><span class='p'>,</span> <span class='mi'>24</span><span class='p'>,</span> <span class='mi'>4</span><span class='p'>,</span> <span class='mi'>19</span><span class='p'>,</span> <span class='mi'>21</span><span class='p'>,</span>
 <span class='mi'>6</span><span class='p'>,</span> <span class='mi'>8</span><span class='p'>,</span> <span class='mi'>23</span><span class='p'>,</span> <span class='mi'>6</span><span class='p'>,</span> <span class='mi'>15</span><span class='p'>,</span> <span class='mi'>4</span><span class='p'>,</span> <span class='mi'>41</span><span class='p'>,</span> <span class='mi'>6</span><span class='p'>,</span> <span class='mi'>7</span><span class='p'>,</span> <span class='mi'>15</span><span class='p'>,</span> <span class='mi'>16</span><span class='p'>,</span> <span class='mi'>10</span><span class='p'>,</span> <span class='mi'>19</span><span class='p'>,</span> <span class='mi'>11</span><span class='p'>,</span> <span class='mi'>20</span><span class='p'>,</span> <span class='mi'>17</span><span class='p'>,</span> <span class='mi'>30</span><span class='p'>,</span> <span class='mi'>10</span><span class='p'>,</span> <span class='mi'>10</span><span class='p'>,</span>
 <span class='mi'>24</span><span class='p'>,</span> <span class='mi'>4</span><span class='p'>,</span> <span class='mi'>29</span><span class='p'>,</span> <span class='mi'>15</span><span class='p'>,</span> <span class='mi'>20</span><span class='p'>,</span> <span class='mi'>14</span><span class='p'>,</span> <span class='mi'>6</span><span class='p'>,</span> <span class='mi'>29</span><span class='p'>,</span> <span class='mi'>6</span><span class='p'>,</span> <span class='mi'>9</span><span class='p'>,</span> <span class='mi'>7</span><span class='p'>,</span> <span class='mi'>24</span><span class='p'>,</span> <span class='mi'>15</span><span class='p'>,</span> <span class='mi'>6</span><span class='p'>,</span> <span class='mi'>11</span><span class='p'>,</span> <span class='mi'>14</span><span class='p'>,</span> <span class='mi'>6</span><span class='p'>,</span> <span class='mi'>12</span><span class='p'>,</span> <span class='mi'>6</span><span class='p'>,</span> <span class='mi'>11</span><span class='p'>,</span>
 <span class='mi'>11</span><span class='p'>,</span> <span class='mi'>17</span><span class='p'>,</span> <span class='mi'>29</span><span class='p'>,</span> <span class='mi'>15</span><span class='p'>,</span> <span class='mi'>22</span><span class='p'>,</span> <span class='mi'>16</span><span class='p'>,</span> <span class='mi'>16</span><span class='p'>,</span> <span class='mi'>31</span><span class='p'>,</span> <span class='mi'>17</span><span class='p'>,</span> <span class='mi'>48</span><span class='p'>,</span> <span class='mi'>23</span><span class='p'>,</span> <span class='mi'>26</span><span class='p'>,</span> <span class='mi'>13</span><span class='p'>,</span> <span class='mi'>6</span><span class='p'>,</span> <span class='mi'>14</span><span class='p'>,</span> <span class='mi'>17</span><span class='p'>,</span> <span class='mi'>49</span><span class='p'>,</span> <span class='mi'>6</span><span class='p'>,</span>
 <span class='mi'>29</span><span class='p'>,</span> <span class='mi'>40</span><span class='p'>,</span> <span class='mi'>11</span><span class='p'>,</span> <span class='mi'>9</span><span class='p'>,</span> <span class='mi'>34</span><span class='p'>,</span> <span class='mi'>15</span><span class='p'>,</span> <span class='mi'>13</span><span class='p'>,</span> <span class='mi'>19</span><span class='p'>,</span> <span class='mi'>26</span><span class='p'>,</span> <span class='mi'>53</span><span class='p'>,</span> <span class='mi'>24</span><span class='p'>,</span> <span class='mi'>15</span><span class='p'>,</span> <span class='mi'>4</span><span class='p'>,</span> <span class='mi'>15</span><span class='p'>,</span> <span class='mi'>14</span><span class='p'>,</span> <span class='mi'>46</span><span class='p'>,</span> <span class='mi'>15</span><span class='p'>,</span> <span class='mi'>19</span><span class='p'>,</span> <span class='mi'>37</span><span class='p'>,</span> <span class='mi'>12</span><span class='p'>,</span> <span class='mi'>31</span><span class='p'>,</span> <span class='mi'>41</span><span class='p'>,</span> <span class='mi'>25</span><span class='p'>,</span> <span class='mi'>4</span><span class='p'>]</span>
<span class='p'>(</span><span class='n'>Pdb</span><span class='p'>)</span>
</code></pre></div>
<p>あるcontourを表示してみると</p>
<div class='highlight'><pre><code class='python'><span class='p'>(</span><span class='n'>Pdb</span><span class='p'>)</span> <span class='n'>contours</span><span class='p'>[</span><span class='mi'>6</span><span class='p'>]</span>
<span class='n'>array</span><span class='p'>([[[</span><span class='mi'>229</span><span class='p'>,</span> <span class='mi'>509</span><span class='p'>]],</span>
       <span class='p'>[[</span><span class='mi'>230</span><span class='p'>,</span> <span class='mi'>508</span><span class='p'>]],</span>
       <span class='p'>[[</span><span class='mi'>231</span><span class='p'>,</span> <span class='mi'>509</span><span class='p'>]],</span>
       <span class='p'>[[</span><span class='mi'>231</span><span class='p'>,</span> <span class='mi'>510</span><span class='p'>]],</span>
       <span class='p'>[[</span><span class='mi'>230</span><span class='p'>,</span> <span class='mi'>511</span><span class='p'>]],</span>
       <span class='p'>[[</span><span class='mi'>229</span><span class='p'>,</span> <span class='mi'>510</span><span class='p'>]]],</span> <span class='n'>dtype</span><span class='o'>=</span><span class='n'>int32</span><span class='p'>)</span>
</code></pre></div>
<p>となっている。単に点の配列でなく、各点をいったん配列でくくったものの配列となっていることに注意。</p>

<p>このcontourを元の画像に重ねて色をつけて表示してみたのが次の図となる。 各点を1pixelの赤い円で表現している。</p>

<p><img src="/images/a_contour.jpg" alt="a_contour.jpg" /></p>

<p>ちなみに全てのcontourを同様に色をつけると <img src="/images/all_contours.jpg" alt="all_contours.jpg" /> となる。</p>

<p>これだと単に文字にそって点があるだけにみえるが、contourが適当に分散して個々のcontourとして認識できるところが 文字の切り出しに役立つのだ。</p>

<p>contourの各点の数を見てわかるようにcontourといっても大小さまざまである。 ここで、ある大きさ以上のcontourだけを表示してみると次のようになる。 <img src="/images/contours_with_thresh.jpg" alt="contours_with_thresh.jpg" /></p>

<h1 id="bounding_rectangle">bounding rectangle</h1>

<p>boundinx rectangleとは <a href="http://docs.opencv.org/trunk/modules/imgproc/doc/structural_analysis_and_shape_descriptors.html?highlight=bounding#cv2.boundingRect">opencvのboundingRect</a>により得られるデータ。 contourの各点を包む矩形を表現する。</p>

<h2 id="code_2">Code</h2>

<p>bounding rectangleを得るコードの主要な部分は</p>
<div class='highlight'><pre><code class='python'><span class='lineno'>1</span>  <span class='c'>#Load image</span>
<span class='lineno'>2</span>  <span class='n'>img</span> <span class='o'>=</span> <span class='n'>cv2</span><span class='o'>.</span><span class='n'>imread</span><span class='p'>(</span><span class='n'>infilename</span><span class='p'>)</span>
<span class='lineno'>3</span>  <span class='c'># get contours</span>
<span class='lineno'>4</span>  <span class='n'>gray</span> <span class='o'>=</span> <span class='n'>cv2</span><span class='o'>.</span><span class='n'>cvtColor</span><span class='p'>(</span><span class='n'>img</span><span class='p'>,</span><span class='n'>cv2</span><span class='o'>.</span><span class='n'>COLOR_BGR2GRAY</span><span class='p'>)</span>
<span class='lineno'>5</span>  <span class='n'>ret</span><span class='p'>,</span><span class='n'>thresh</span> <span class='o'>=</span> <span class='n'>cv2</span><span class='o'>.</span><span class='n'>threshold</span><span class='p'>(</span><span class='n'>gray</span><span class='p'>,</span> <span class='n'>thresh_low</span><span class='p'>,</span> <span class='n'>thresh_high</span><span class='p'>,</span> <span class='mi'>0</span><span class='p'>)</span>                                                                          <span class='err'>│</span>
<span class='lineno'>6</span>  <span class='n'>contours</span><span class='p'>,</span> <span class='n'>hierarchy</span> <span class='o'>=</span> <span class='n'>cv2</span><span class='o'>.</span><span class='n'>findContours</span><span class='p'>(</span><span class='n'>thresh</span><span class='p'>,</span><span class='n'>cv2</span><span class='o'>.</span><span class='n'>RETR_LIST</span><span class='p'>,</span><span class='n'>cv2</span><span class='o'>.</span><span class='n'>CHAIN_APPROX_SIMPLE</span><span class='p'>)</span>
</code></pre></div>
<p>のようになる。 このbounding boxとの組合せで「文字の切り出し」という目的に一歩近づく。</p>

<p>さきほどののcontourを包む矩形を 元の画像に重ねて色をつけて表示してみたのが次の図となる。 矩形を青い線で表示している。</p>

<p>ちなみに全てのcontourのboundingRectを同様に表示すると となる。</p>

<p>contourの各点の数を見てわかるようにcontourといっても大小さまざまである。 ここで、ある大きさ以上のcontourのbounding rectangleだけを表示してみると次のようになる。</p>

<p>これなら「文字の切り出し」という目的に一歩近づいてることがわかるだろう。</p>

<h1 id="centroids">centroids</h1>

<p>centoroidとは重心のことで、bounding rectangleの各重心は次のように簡単に求められる。</p>

<p>その重心だけをplotしたのが次の画像である</p>

<p>bounding rectangle の大きさを限定することで、ポイントから漏れる文字も出てくるが、多数はおおむね文字の中心付近にあることがわかる。 したがって、このcentroidsのデータから、文字の区画線を推定することができそうだ。</p>

<h1 id="divide_page">divide page</h1>

<p>さて、これまで小さなサンプル画像で説明してきたが、実際には近デジでいうところの「コマ」画像、 たとえばこのような 本の見開き、2ページぶんを一枚に収めた画像を処理したい。 そのためにはまず、1ページづつに対象を分けたい。 その作業にも centroidsのデータが使える。</p>

<h1 id="kmeans">kmeans法によるクラスタリング</h1>

<p>クラスタリングとは<a href="">このページ</a>にわかりやすくvizualizeされているように、あるデータの集合を要素間の距離を基準にして複数のグループにわけることだ。 opencvでは点の集合をクラスタリングする関数<a href="http://docs.opencv.org/trunk/modules/core/doc/clustering.html?highlight=kmeans#cv2.kmeans">kmeans</a>が用意されている。 あるコマの画像に対してcentroidsを重ねて表示したのが次の画像となるが、 このcentroidsを、クラスタリングにより2つに分類すればおのずと右のページの文字、左のページの文字とにわかれると期待できる。</p>
<div class='highlight'><pre><code class='python'><span class='lineno'>1</span> 
</code></pre></div>
<p>そうやってわけた画像が次のようになる。</p>

<h1 id="fitline">fitline</h1>

<p>さて、2つにわけたものの、左のほうをみると明らかだが 画面が傾いている。 この画像の生成過程を想像すればやむをえないのだろうが、残念ながら近デジの画像の多くはこのようにかたむいている。 これを補正するためにcentroidsのデータを利用して傾きを推定する。 まず、centroidsを各行に分類する。 centroidsのデータの数字を、x座標の昇順に並べかえるとこうなる。 これをながめるとy座標の増減が波になっていることがわかる。 y座標の増加傾向と減少傾向の変わり目が行の変わり目にほかならない。 したがって次のようなコード</p>
<div class='highlight'><pre><code class='python'><span class='lineno'>1</span> 
</code></pre></div>
<p>により、行ごとにcentroidを分類できた。</p>

<p>さて、各行につき、回帰直線を推定する。opencvには <a href="http://docs.opencv.org/trunk/modules/imgproc/doc/structural_analysis_and_shape_descriptors.html?highlight=fit%20line#cv2.fitLine">fitLine</a>という関数があるので次のように簡単に求まる。</p>
<div class='highlight'><pre><code class='python'><span class='lineno'>1</span> 
</code></pre></div>
<p>各直線の通過点のデータは</p>
<div class='highlight'><pre><code class='python'><span class='lineno'>1</span> 
</code></pre></div>
<p>となるので、各行の間隔が求まる。</p>

<p>この戻り値のベクトルから回転角度がわかるので逆に回転すればよい。</p>

<p>こうして求めた回転前後の画像の例をいくつかあげてみる</p>

<p>これは という本の コマ目の左である。 回転前はこう。 <img src="/images/before_rotate.jpg" alt="before_rotate.jpg" /></p>

<p>回転後はこう。 <img src="/images/after_rotate.jpg" alt="after_rotate.jpg" /></p>

<h1 id="">文字の切り出しへ</h1>

<p>回転後の各行の画像は、すでに求めた間隔によればよいので このように</p>
<div class='highlight'><pre><code class='python'><span class='lineno'>1</span> 
</code></pre></div>
<p>とりだせ、その結果は <img src="/images/columns.jpg" alt="columns.jpg" /> となる。</p>

<p>縦位置の区切り 句読点、役物、2字連結などがあるので、縦位置の区切りは行ごとに異なることがよくあるので、個々の行ごとに行なう。</p>
<script src='https://gist.github.com/5598133.js?file=creature.rb'> </script>
</div>

<footer>
  <p>
<a rel="license" href="http://creativecommons.org/licenses/by/4.0/"><img alt="クリエイティブ・コモンズ・ライセンス" style="border-width:0" src="http://i.creativecommons.org/l/by/4.0/80x15.png" /></a><a rel="license" href="http://creativecommons.org/licenses/by/4.0/">クリエイティブ・コモンズ 表示 4.0 国際 ライセンス</a>  skkmania 2014 
          with help from <a href="http://jekyllbootstrap.com" target="_blank" title="The Definitive Jekyll Blogging Framework">Jekyll Bootstrap</a>
  </p>
</footer>

  <p>- rendered with layout template -</p>
</body>
